<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Recommend a Policy - Policy Predictor</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#317EFB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="PolicyPredict">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <meta name="description" content="Get personalized insurance policy recommendations">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="./css/recommend.css">
    <link rel="stylesheet" href="./css/install-prompt.css">
</head>
<body>
    <div id="online-status"></div>
    <div class="container">
        <!-- Recommendation UI -->
        <div class="recommend-box">
            <h1>Policy Recommendation</h1>
            <div class="input-container">
                <textarea id="userInput" 
                    placeholder="Tell us about your insurance needs and requirements..." 
                    rows="4"
                    data-mobile-rows="3"
                ></textarea>
                <button onclick="getRecommendations()" class="primary-button">Get Recommendations</button>
            </div>

            <div id="recommendations" style="display: none;">
                <h2>Recommended Policies</h2>
                <ul id="policyList" class="policy-list"></ul>
            </div>
        </div>
    </div>

    <script>
        // Check if service worker is registered
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./service-worker.js', {
                        scope: './'
                    });
                    console.log('ServiceWorker registration successful');
                } catch (err) {
                    console.error('ServiceWorker registration failed:', err);
                }
            });
        }

        async function getRecommendations() {
            const userInput = document.getElementById("userInput").value;
            if (!userInput.trim()) {
                alert("Please describe your insurance needs.");
                return;
            }

            try {
                const res = await fetch('./api/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: userInput })
                });

                if (!res.ok) throw new Error('Failed to fetch recommendations');

                const policies = await res.json();
                const policyList = document.getElementById("policyList");
                policyList.innerHTML = "";
                document.getElementById("recommendations").style.display = "block";
                
                policies.forEach(policy => {
                    const listItem = document.createElement("li");
                    listItem.innerHTML = `
                        <div class="policy-item">
                            <div class="policy-header">
                                <input type="radio" name="selectedPolicy" value="${policy.name}" id="${policy.name}">
                                <label for="${policy.name}" class="policy-name">${policy.name}</label>
                            </div>
                            <div class="policy-why-container">
                                <h3 class="policy-why-heading">Why this policy suits you:</h3>
                                <div class="policy-description">${policy.why || 'Description not available'}</div>
                            </div>
                        </div>
                    `;
                    policyList.appendChild(listItem);
                });

                document.getElementById("submitSelection").style.display = "block";
            } catch (error) {
                console.error('Error:', error);
                alert("Failed to get recommendations. Please try again.");
            }
        }

        document.getElementById("submitSelection").addEventListener("click", async function() {
            const selected = document.querySelector('input[name="selectedPolicy"]:checked');
            if (!selected) {
                alert("Please select a policy first.");
                return;
            }

            try {
                const res = await fetch('./api/select-policy-rec', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ policy: selected.value })
                });

                if (!res.ok) throw new Error('Failed to save selection');
                alert("Your policy selection has been saved!");
            } catch (error) {
                console.error('Error:', error);
                alert("Failed to save your selection. Please try again.");
            }
        });

        // Update online status display
        function updateOnlineStatus() {
            const statusIndicator = document.getElementById('online-status');
            if (!statusIndicator) return;
            
            if (navigator.onLine) {
                statusIndicator.textContent = 'ðŸŸ¢ Online';
                statusIndicator.classList.remove('offline');
                statusIndicator.classList.add('online');
            } else {
                statusIndicator.textContent = 'ðŸ”´ Offline';
                statusIndicator.classList.remove('online');
                statusIndicator.classList.add('offline');
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        document.addEventListener('DOMContentLoaded', updateOnlineStatus);

        // Device detection
        function isMobileDevice() {
            return (window.innerWidth <= 767);
        }

        // Adjust textarea rows based on device
        function adjustTextarea() {
            const textarea = document.getElementById('userInput');
            if (textarea) {
                textarea.rows = isMobileDevice() ? 
                    parseInt(textarea.getAttribute('data-mobile-rows')) : 4;
            }
        }

        // Call on load and resize
        window.addEventListener('load', adjustTextarea);
        window.addEventListener('resize', adjustTextarea);
    </script>
</body>
</html>
